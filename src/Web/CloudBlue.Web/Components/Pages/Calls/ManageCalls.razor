@page "/calls/manage"
@using CloudBlue.Domain.DomainModels.CallLeads
@using CloudBlue.Domain.DomainModels.Filtration.Interfaces
@using CloudBlue.Domain.GenericTypes
@inject IJSRuntime JSRuntime;

<style>
   /*  .rz-grid-table { width: 1095px !important; }
 */
    .rz-grid-table td .rz-cell-data {
        overflow-wrap: break-word;
        white-space: normal;
        word-wrap: break-word;
    }
     
</style>


<RadzenStack>

<RadzenTemplateForm TItem="CallsFiltersModel" Data="@_callsFilters">


<RadzenPanel AllowCollapse="true" class="rz-my-10 rz-mx-auto">
<HeaderTemplate>
    <RadzenText TextStyle="TextStyle.H6" class="rz-display-flex rz-align-items-center rz-m-0">
        <RadzenIcon Icon="filter_alt" class="rz-me-1"/><b>Filters</b>
    </RadzenText>
</HeaderTemplate>

<ChildContent>
                 


<RadzenFieldset AllowCollapse="true">
    <HeaderTemplate>
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
            <RadzenIcon Icon="filter" class="titleSpan"/>
            <b>
                <span class="titleSpan">Basic Filters</span>
            </b>
        </RadzenStack>
    </HeaderTemplate>
    <ChildContent>
        <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenFormField Text="Client Name" Variant="Variant.Outlined" Style="width: 100%;">

                    <RadzenTextBox style="display: block; width: 100%" @bind-Value="@_callsFilters.ClientName" Name="ClientName"/>

                </RadzenFormField>


            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="6">

                <RadzenFormField Text="Client Name (Arabic)" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenTextBox style="display: block; width: 100%" @bind-Value="@_callsFilters.ClientNameArabic" Name="ClientNameArabic"/>
                </RadzenFormField>


            </RadzenColumn>
        </RadzenRow>
        <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenFormField Text="Call Status" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenCheckBoxList Data="@_callStatuses" TextProperty="ItemName" ValueProperty="ItemId" @bind-Value="@_callsFilters.EntityStatusIds" TValue="int">

                    </RadzenCheckBoxList>
                </RadzenFormField>


            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="3">

                <RadzenFormField Text="Call Date (From)" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenDatePicker AllowClear="true" DateFormat="dd/MM/yyyy" style="display: block; width: 100%" AllowInput="false" @bind-Value="@_callsFilters.EntityCreationDateFrom" Name="EntityCreationDateFrom" />
                </RadzenFormField>


            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="3">

                <RadzenFormField Text="Call Date (To)" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDatePicker  AllowClear="true" DateFormat="dd/MM/yyyy" style="display: block; width: 100%" AllowInput="false" @bind-Value="@_callsFilters.EntityCreationDateTo" Name="EntityCreationDateTo"/>
                </RadzenFormField>


            </RadzenColumn>
        </RadzenRow>


        <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
            <RadzenColumn Size="12" SizeMD="2">
                <RadzenFormField Variant="Variant.Outlined" Text="Country Code">

                    <RadzenDropDown AllowClear="true" Name="CountryId" @bind-Value="@ClientContactDevice.CountryId" Data="@_countries" TextProperty="ItemName" ValueProperty="ItemId" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Select Country" Style="width: 100%;">
                        <Template Context="newcontext">
                            @{
                                var val = newcontext as LookupItem<int>;
                            }
                            <span>@($"({val.ExtraId}) {val.ItemName}")</span>

                        </Template>
                    </RadzenDropDown>


                </RadzenFormField>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="2">

                <RadzenFormField Text="Area Code" Variant="Variant.Outlined">
                    <RadzenTextBox MaxLength="4" onkeypress="allowOnlyNumbers(event)"
                                   oninput="applyChange(4)" Name="AreaCode" @bind-Value="@ClientContactDevice.PhoneAreaCode"/>
                    <RadzenDataAnnotationValidator Popup="true" Style="position: absolute" Component="AreaCode" ComponentProperty="Value"/>

                </RadzenFormField>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="2">

                <RadzenFormField Text="Phone" Variant="Variant.Outlined">
                    <RadzenTextBox Name="Phone" oninput="applyChange(8)"
                                   onkeypress="allowOnlyNumbers(event)"
                                   MaxLength="8" @bind-Value="@ClientContactDevice.Phone"/>

                    <RadzenDataAnnotationValidator Popup="true" Style="position: absolute" Component="Phone" ComponentProperty="Value"/>
                </RadzenFormField>
            </RadzenColumn>


            <RadzenColumn Size="12" SizeMD="6">
                <RadzenFormField Text="Internl. Numbers" Variant="Variant.Outlined" Style="width: 100%;">

                    <RadzenDropDown AllowClear="true" Name="InternationalOnly" Data="@_intlNoOptions" TextProperty="ItemName" ValueProperty="ItemId" @bind-Value="@_callsFilters.InternationalOnly" Style="width: 100%;"/>

                </RadzenFormField>


            </RadzenColumn>

        </RadzenRow>

        <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenFormField Text="Call Type" Variant="Variant.Outlined" Style="width: 100%;">

                    <RadzenDropDown AllowClear="true" Name="CallTypeId" Data="@_callTypes" TextProperty="ItemName" ValueProperty="ItemId" @bind-Value="@_callsFilters.CallTypeId" Style="width: 100%;"/>

                </RadzenFormField>


            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenFormField Text="Recipient of Call" Variant="Variant.Outlined" Style="width: 100%;">

                    <RadzenDropDown AllowClear="true" Name="CreatedById" Data="@_callRecipients" TextProperty="ItemName" ValueProperty="ItemId" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" @bind-Value="@_callsFilters.CreatedById" Style="width: 100%;"/>

                </RadzenFormField>


            </RadzenColumn>

        </RadzenRow>


    </ChildContent>
</RadzenFieldset>


                        <RadzenFieldset AllowCollapse="true">
                            <HeaderTemplate>
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
                                    <RadzenIcon Icon="filter" class="titleSpan"/>
                                    <b>
                                        <span class="titleSpan">Advanced Filters</span>
                                    </b>
                                </RadzenStack>
                            </HeaderTemplate>


                            <ChildContent>
                                <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Lead Source" Variant="Variant.Outlined" Style="width: 100%;">

                                            <RadzenDropDown AllowClear="true" Name="LeadSourceId" @bind-Value="@_callsFilters.LeadSourceId" Data="@_leadSources" TextProperty="ItemName" ValueProperty="ItemId" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Select Lead Source" Style="width: 100%;"/>


                                        </RadzenFormField>


                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="3">
                                        <RadzenFormField Text="How did You Hear About us?" Variant="Variant.Outlined" Style="width: 100%;">
                                            <RadzenDropDown AllowClear="true"
                                                            Change="KnowSourceChanged"
                                                            Name="KnowSourceId" @bind-Value="@_callsFilters.KnowSourceId" Data="@_knowItems" TextProperty="ItemName" ValueProperty="ItemId" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Select Know Item" Style="width: 100%;"/>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="3">
                                        <RadzenFormField Text="How did You Hear About us more?" Variant="Variant.Outlined" Style="width: 100%;">

                                            <RadzenDropDown AllowClear="true" Name="KnowSubSourceId" @bind-Value="@_callsFilters.KnowSubSourceId" Data="@_knowSubItems" TextProperty="ItemName" ValueProperty="ItemId" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Select Know Sub Item" Style="width: 100%;"/>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                                <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Client Category" Variant="Variant.Outlined" Style="width: 100%;">

                                            <RadzenDropDown AllowClear="true" Name="ClientCategoryId" @bind-Value="@_callsFilters.ClientCategoryId" Data="@_clientCategories" TextProperty="ItemName" ValueProperty="ItemId" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Select Client Category" Style="width: 100%;"/>


                                        </RadzenFormField>


                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="3">
                                        <RadzenFormField Text="Company" Variant="Variant.Outlined" Style="width: 100%;">
                                            <RadzenDropDown AllowClear="true" Change="CompanyChanged"
                                                            Name="CompanyId" @bind-Value="@_callsFilters.CompanyId" Data="@_companies" TextProperty="ItemName" ValueProperty="ItemId" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Select Company" Style="width: 100%;"/>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="3">
                                        <RadzenFormField Text="Branch" Variant="Variant.Outlined" Style="width: 100%;">

                                            <RadzenDropDown AllowClear="true" Name="BranchId" @bind-Value="@_callsFilters.BranchId" Data="@_branches" TextProperty="ItemName" ValueProperty="ItemId" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Select Branch" Style="width: 100%;"/>


                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>

                            </ChildContent>
                        </RadzenFieldset>
                    
<RadzenButton ButtonType="ButtonType.Submit" Shade="Shade.Lighter" Click="@Search" Text="Search" ButtonStyle="ButtonStyle.Secondary"/>
                  @* 
<RadzenButton ButtonType="ButtonType.Submit" class="floating-button" Shade="Shade.Lighter" Click="@Search" Text="Search" ButtonStyle="ButtonStyle.Primary"/> *@
<RadzenButton Shade="Shade.Lighter" Click="@ResetFilters" Text="Reset Filters" ButtonStyle="ButtonStyle.Primary"/>
               

</ChildContent>
</RadzenPanel>

</RadzenTemplateForm>
<RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
    <RadzenColumn Size="12" SizeMD="12">
        <RadzenButton Text="Reset Grid" Click="@(args => { _grid.Reset(); })" class="rz-my-4"/>

        <RadzenDataGrid @ref="_grid" AllowColumnPicking="true" AllowColumnResize="true" AllowPickAllColumns="true" Style="min-width: 100px; overflow-x: auto; width: 1100px;"

                        Count="@_totalNumber" ColumnWidth="100px"
                        AllowAlternatingRows="true" AllowColumnReorder="true"
                        AllowPaging="true"

                        AllowSorting="true"
                        SelectionMode="DataGridSelectionMode.Multiple"
                        LoadData="@LoadData"
                            ShowPagingSummary="true" PageSizeOptions="@(new[] { 5, 10, 25,50,100 })"
                        Data="@_calls" TItem="CallItemForList">
            <Columns>
                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" Pickable="false" TItem="CallItemForList" Property="@nameof(CallItemForList.Id)" Title="Id" Sortable="true">
                    <Template Context="data">
                        <RadzenCheckBox TabIndex="-1" TriState="false" Value="@(_selectItems.Contains(data))" InputAttributes="@(new Dictionary<string, object> { { "aria-label", "Select item" } })"
                                        TValue="bool" Change="@(args => { _grid.SelectRow(data); })"/>
                        @data.Id
                    </Template>

                </RadzenDataGridColumn>
                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" TItem="CallItemForList" Property="@nameof(CallItemForList.ClientName)" Title="Client">
                </RadzenDataGridColumn>
                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" TItem="CallItemForList" Sortable="false" Property="@nameof(CallItemForList.ClientPhone)" Title="Mobile">
                </RadzenDataGridColumn>
                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" TItem="CallItemForList" Property="@nameof(CallItemForList.CallType)" Title="Call Type">
                    <Template Context="data">

                        <RadzenBadge BadgeStyle="@((BadgeStyle)data.CallTypeBadgeStyle)" Text="@data.CallType"> </RadzenBadge>

                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" TItem="CallItemForList" Property="@nameof(CallItemForList.CreationDate)" Title="Date">
                </RadzenDataGridColumn>

                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" TItem="CallItemForList" Property="@nameof(CallItemForList.CallStatus)" Title="Status">
                    <Template Context="data">

                        <RadzenBadge Shade="Shade.Dark" BadgeStyle="@((BadgeStyle)data.CallStatusBadgeStyle)" Text="@data.CallStatus"> </RadzenBadge>

                    </Template>
                </RadzenDataGridColumn>


                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" TItem="CallItemForList" Visible="false" Property="@nameof(CallItemForList.BranchName)" Title="Branch">
                </RadzenDataGridColumn>


                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" TItem="CallItemForList" Visible="false" Property="@nameof(CallItemForList.CreatedBy)" Title="Call Recipient"></RadzenDataGridColumn>

                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" TItem="CallItemForList" Visible="false" Property="@nameof(CallItemForList.LeadSource)" Title="Lead Source"></RadzenDataGridColumn>

                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" TItem="CallItemForList" Visible="false" Property="@nameof(CallItemForList.KnowSource)" Title="Hear About us">
                    <Template Context="data">
                        @($"{data.KnowSource} - {data.KnowSubSource}")
                    </Template>

                </RadzenDataGridColumn>

                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" TItem="CallItemForList" Visible="false" Property="@nameof(CallItemForList.PropertyType)" Title="Property Type"></RadzenDataGridColumn>

                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" TItem="CallItemForList" Visible="false" Property="@nameof(CallItemForList.Location)" Title="Location"></RadzenDataGridColumn>

                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" TItem="CallItemForList" Visible="false" Property="@nameof(CallItemForList.DurationStr)" Title="Call Duration"></RadzenDataGridColumn>


                <RadzenDataGridColumn HeaderCssClass="datagrid-custom-header" Property="" Title="Call Details">
                    <Template Context="data">
                        <RadzenButton ButtonStyle="ButtonStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" Icon="info" class="rz-m-1" Click="@(() => OpenCall(data.Id))" Text="Peek"/>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>

        </RadzenDataGrid>

    </RadzenColumn>
</RadzenRow>
</RadzenStack>